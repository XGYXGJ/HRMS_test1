<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>
            工资单明细
            <small class="text-muted" th:text="'(月份: ' + ${master.payDate} + ')'"></small>
        </h4>

        <div class="d-flex gap-2">
            <!-- 发送审核：仅 Draft(草稿) 或 Rejected(驳回) 允许 -->
            <form th:action="'/salary/register/send-for-audit/' + ${master.registerId}"
                  method="post"
                  th:if="${master.auditStatus == 'Draft' or master.auditStatus == 'Rejected'}"
                  onsubmit="return confirm('确定要将此工资单发送给管理员进行审核吗？')">
                <button type="submit" class="btn btn-success">发送审核</button>
            </form>

            <!-- 撤回：仅 Pending(待审核) 状态显示，将单据撤回为草稿 -->
            <form th:action="'/salary/register/recall/' + ${master.registerId}"
                  method="post"
                  th:if="${master.auditStatus == 'Pending'}"
                  onsubmit="return confirm('确定要撤回该工资单并变回草稿状态吗？撤回后可以重新修改绩效。')">
                <button type="submit" class="btn btn-warning">撤回到草稿</button>
            </form>

            <button onclick="loadContent('/salary/register/list')" class="btn btn-secondary">
                返回列表
            </button>
        </div>
    </div>

    <div th:if="${master}" class="alert alert-info py-2 small">
        <strong>单号:</strong>
        <span th:text="${master.registerCode}">PAY2025121101</span> |
        <strong>发放日期:</strong> <span th:text="${master.payDate}"></span> |
        <strong>审核状态:</strong>
        <span th:if="${master.auditStatus == 'Draft'}" class="badge bg-secondary">草稿</span>
        <span th:if="${master.auditStatus == 'Pending'}" class="badge bg-warning text-dark">待审核</span>
        <span th:if="${master.auditStatus == 'Approved'}" class="badge bg-success">已发放</span>
        <span th:if="${master.auditStatus == 'Rejected'}" class="badge bg-danger">已驳回</span>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>员工账号</th>
                        <th>姓名</th>
                        <th>职位</th>

                        <th>基本工资</th>
                        <th>各补贴</th>
                        <th>考勤奖惩</th>
                        <th>绩效奖金</th>
                        <th>各保险费用</th>
                        <th>实发工资</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="emp : ${finalDetails}">
                        <!-- 员工账号：T_User.Username -->
                        <td th:text="${emp.username}">emp01</td>

                        <!-- 姓名：T_Personnel_File.Name -->
                        <td th:text="${emp.userName}">张三</td>

                        <!-- 职位名称 -->
                        <td th:text="${emp.positionName}">软件工程师</td>

                        <!-- 基本工资 -->
                        <td th:text="${#numbers.formatDecimal(emp.baseSalary, 1, 'COMMA', 2, 'POINT')}">0.00</td>

                        <!-- 各补贴（合计），使用工资明细表中的 Total_Subsidy -->
                        <td th:text="${#numbers.formatDecimal(emp.totalSubsidy, 1, 'COMMA', 2, 'POINT')}">0.00</td>

                        <!-- 考勤奖惩：正值绿色，负值红色 -->
                        <td th:text="${#numbers.formatDecimal(emp.attendanceAdjustment, 1, 'COMMA', 2, 'POINT')}"
                            th:classappend="${emp.attendanceAdjustment} >= 0 ? ' text-success' : ' text-danger'">0.00
                        </td>

                        <!-- 绩效奖金 -->
                        <td th:text="${#numbers.formatDecimal(emp.kpiBonus, 1, 'COMMA', 2, 'POINT')}">0.00</td>

                        <!-- 各保险费用合计：工资明细表中的 Insurance_Fee -->
                        <td class="text-danger"
                            th:text="${#numbers.formatDecimal(emp.insuranceFee, 1, 'COMMA', 2, 'POINT')}">0.00</td>

                        <!-- 实发工资 = 基本工资 + 补贴 + 考勤奖惩 + 绩效奖金 - 各保险费用（后端已算好 Gross_Money） -->
                        <td class="fw-bold text-success"
                            th:text="${#numbers.formatDecimal(emp.grossMoney, 1, 'COMMA', 2, 'POINT')}">0.00</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div th:if="${#lists.isEmpty(finalDetails)}" class="card-footer text-center text-muted">
            本月工资单暂无员工明细数据。
        </div>
    </div>

    <!-- =================== Modal + 自动弹窗（放在文件最底部） =================== -->

    <!-- Bootstrap Modal 提示框 -->
    <div class="modal fade" id="toastModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="toastTitle">提示</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="toastBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">知道了</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自动弹窗脚本：error/msg 有值就弹 -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const err = /*[[${error}]]*/ null;
        const msg = /*[[${msg}]]*/ null;

        const text = err || msg;
        if (text) {
            document.getElementById('toastBody').innerText = text;
            document.getElementById('toastTitle').innerText = err ? "操作失败" : "操作成功";
            const modal = new bootstrap.Modal(document.getElementById('toastModal'));
            modal.show();
        }
        /*]]>*/
    </script>
</div>
