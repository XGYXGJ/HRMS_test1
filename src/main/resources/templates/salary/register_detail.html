<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>
            工资单明细
            <small class="text-muted" th:text="'(月份: ' + ${master.payDate} + ')'"></small>
        </h4>

        <div class="d-flex gap-2">
            <!-- 发送审核：仅 Draft(草稿) 或 Rejected(驳回) 允许 -->
            <form th:action="'/salary/register/send-for-audit/' + ${master.registerId}"
                  method="post"
                  th:if="${master.auditStatus == 'Draft' or master.auditStatus == 'Rejected'}"
                  onsubmit="return confirm('确定要将此工资单发送给管理员进行审核吗？')">
                <button type="submit" class="btn btn-success">发送审核</button>
            </form>

            <button onclick="loadContent('/salary/register/list')" class="btn btn-secondary">返回列表</button>
        </div>
    </div>

    <div th:if="${master}" class="alert alert-info py-2 small">
        <strong>单号:</strong> <span th:text="${master.registerId}"></span> |
        <strong>发放日期:</strong> <span th:text="${master.payDate}"></span> |
        <strong>审核状态:</strong>
        <span th:if="${master.auditStatus == 'Draft'}" class="badge bg-secondary">草稿</span>
        <span th:if="${master.auditStatus == 'Pending'}" class="badge bg-warning text-dark">待审核</span>
        <span th:if="${master.auditStatus == 'Approved'}" class="badge bg-success">已发放</span>
        <span th:if="${master.auditStatus == 'Rejected'}" class="badge bg-danger">已驳回</span>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>员工编号</th>
                        <th>姓名</th>
                        <th>职位</th>

                        <th th:each="item : ${allItems}" th:text="${item.itemName}">薪酬项目名称</th>

                        <th>实发金额 (应发合计)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="emp : ${finalDetails}">
                        <td th:text="${emp.userId}">101</td>
                        <td th:text="${emp.userName}">张三</td>
                        <td th:text="${emp.positionName}">软件工程师</td>

                        <td th:each="item : ${allItems}">
                            <span th:with="value=${emp.itemValues.get(item.itemId)}">
                                <span th:text="${value != null ? #numbers.formatDecimal(value, 1, 'COMMA', 2, 'POINT') : '0.00'}">0.00</span>
                            </span>
                        </td>

                        <td class="fw-bold text-success" th:text="${#numbers.formatDecimal(emp.grossMoney, 1, 'COMMA', 2, 'POINT')}">5500.00</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div th:if="${#lists.isEmpty(finalDetails)}" class="card-footer text-center text-muted">
            本月工资单暂无员工明细数据。
        </div>
    </div>

    <!-- =================== Modal + 自动弹窗（放在文件最底部） =================== -->

    <!-- Bootstrap Modal 提示框 -->
    <div class="modal fade" id="toastModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="toastTitle">提示</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="toastBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">知道了</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自动弹窗脚本：error/msg 有值就弹 -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const err = /*[[${error}]]*/ null;
        const msg = /*[[${msg}]]*/ null;

        const text = err || msg;
        if (text) {
            document.getElementById('toastBody').innerText = text;
            document.getElementById('toastTitle').innerText = err ? "操作失败" : "操作成功";
            const modal = new bootstrap.Modal(document.getElementById('toastModal'));
            modal.show();
        }
        /*]]>*/
    </script>
</div>
