<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>员工职位调整</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h3>员工职位调整</h3>
    <a th:href="@{/hr/dashboard}" class="btn btn-secondary mb-3">返回工作台</a>

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <form method="post" th:action="@{/hr/positions/change}">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="userId" class="form-label">选择员工</label>
                    <select id="userId" name="userId" class="form-select" required>
                        <option th:each="employee : ${employees}" th:value="${employee.userId}" th:text="${employee.name}"></option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="positionId" class="form-label">选择新职位</label>
                    <select id="positionId" name="positionId" class="form-select" required>
                        <option th:each="position : ${positions}" th:value="${position.positionId}" th:text="${position.positionName}"></option>
                    </select>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">确认调整</button>
    </form>

    <hr class="my-4">

    <div>
        <h3>员工选择列表</h3>
        <div class="mb-3">
            <input id="search-input" placeholder="按姓名/当前岗位搜索" class="form-control d-inline-block" style="width: 300px;" />
            <button id="search-btn" class="btn btn-primary">搜索</button>
        </div>

        <table class="table table-striped" id="employee-table">
            <thead>
            <tr>
                <th>档案号</th>
                <th>姓名</th>
                <th>当前岗位</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <!-- 员工数据将通过API动态加载 -->
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-input');
        const employeeTableBody = document.querySelector('#employee-table tbody');

        function fetchEmployees(name, position) {
            let url = '/api/employees';
            const params = new URLSearchParams();
            if (name) params.append('name', name);
            if (position) params.append('position', position);
            if (params.toString()) {
                url += '?' + params.toString();
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    employeeTableBody.innerHTML = '';
                    data.forEach(employee => {
                        const row = `
                            <tr>
                                <td>${employee.archiveNo}</td>
                                <td>${employee.name}</td>
                                <td>${employee.position}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="selectEmployee(${employee.userId}, '${employee.name}')">选择</button>
                                </td>
                            </tr>
                        `;
                        employeeTableBody.insertAdjacentHTML('beforeend', row);
                    });
                })
                .catch(error => console.error('Error fetching employees:', error));
        }

        searchBtn.addEventListener('click', () => {
            const searchTerm = searchInput.value.trim();
            // A simple way to distinguish between name and position, you might need a more robust solution
            const isPosition = searchTerm.includes('师') || searchTerm.includes('经理') || searchTerm.includes('专员');
            if (isPosition) {
                fetchEmployees(null, searchTerm);
            } else {
                fetchEmployees(searchTerm, null);
            }
        });

        // Initial load
        fetchEmployees();
    });

    function selectEmployee(userId, name) {
        const select = document.getElementById('userId');
        // Check if the employee is already in the dropdown
        let found = false;
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value == userId) {
                select.selectedIndex = i;
                found = true;
                break;
            }
        }
        // If not, add them
        if (!found) {
            const newOption = new Option(name, userId, true, true);
            select.add(newOption);
        }
    }
</script>

</body>
</html>
