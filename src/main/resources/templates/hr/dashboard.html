<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>人事经理工作台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/dashboard-common.css">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">

    <style>
        /* 人事经理特有样式 */
        .dashboard-card .card-title {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand" href="javascript:void(0)" onclick="loadContent('/hr/dashboard/home', this)">
        <i class="bi bi-person-workspace me-2"></i>HRMS系统 - 人事经理
    </a>
    <span class="text-white">欢迎，<span th:text="${session.user.username}">User</span></span>
    <a href="/logout" class="btn btn-sm btn-outline-light ms-3">
        <i class="bi bi-box-arrow-right me-1"></i>退出
    </a>
</nav>

<div class="sidebar">
    <div class="list-group list-group-flush" id="sidebarMenu">
        <a class="list-group-item list-group-item-action active" onclick="loadContent('/hr/dashboard/home', this)">
            <i class="bi bi-speedometer2"></i> 仪表盘
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/hr/personnel/list', this)">
            <i class="bi bi-people-fill"></i> 人事档案管理
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/hr/position/list', this)">
            <i class="bi bi-diagram-3-fill"></i> 职位管理
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/hr/position/change', this)">
            <i class="bi bi-person-badge-fill"></i> 员工职位调整
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/hr/attendance/management', this)">
            <i class="bi bi-calendar-check-fill"></i> 考勤管理
        </a>

        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
            <span>个人中心</span>
        </h6>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/emp/profile', this)">
            <i class="bi bi-person-vcard me-2"></i> 个人资料
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/emp/attendance', this)">
            <i class="bi bi-calendar-check me-2"></i> 考勤打卡
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/emp/salary', this)">
            <i class="bi bi-cash-stack me-2"></i> 我的工资单
        </a>
    </div>
</div>

<div class="main-content">
    <div id="loading" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-3 text-muted">正在处理，请稍候...</p>
    </div>

    <div id="content-area">
        <!-- 内容将在这里动态加载 -->
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-cn.js"></script>
<script>
    // 初始化：默认加载仪表盘首页
    document.addEventListener('DOMContentLoaded', function() {
        loadContent('/hr/dashboard/home', document.querySelector('#sidebarMenu a.active'));
    });

    function executeScripts(container) {
        const scripts = container.querySelectorAll("script");
        scripts.forEach(script => {
            const newScript = document.createElement("script");
            if (script.src) {
                newScript.src = script.src;
            } else {
                newScript.innerHTML = script.innerHTML;
            }
            document.body.appendChild(newScript);
            script.remove(); // 避免重复执行
        });
    }

    function loadContent(url, element) {
        if (element && element.classList.contains('list-group-item')) {
            document.querySelectorAll('#sidebarMenu .list-group-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
        }

        const contentArea = document.getElementById('content-area');
        const loading = document.getElementById('loading');

        contentArea.style.opacity = '0.5';
        loading.style.display = 'block';

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error("网络响应异常");
                return response.text();
            })
            .then(html => {
                contentArea.innerHTML = html;
                executeScripts(contentArea); // 执行新加载内容中的脚本
                contentArea.style.opacity = '1';
                loading.style.display = 'none';
                bindFormEvents();
            })
            .catch(err => {
                contentArea.innerHTML = `<div class="alert alert-danger">加载失败: ${err.message}</div>`;
                loading.style.display = 'none';
                contentArea.style.opacity = '1';
            });
    }

    function bindFormEvents() {
        const forms = document.querySelectorAll('#content-area form');

        forms.forEach(form => {
            form.onsubmit = function(event) {
                event.preventDefault();

                const parentModal = form.closest('.modal.show');
                if (parentModal) {
                    let modalInstance = bootstrap.Modal.getInstance(parentModal);
                    if (!modalInstance) {
                        modalInstance = new bootstrap.Modal(parentModal);
                    }
                    modalInstance.hide();
                }

                if (form.getAttribute('onsubmit_confirm')) {
                    if (!confirm(form.getAttribute('onsubmit_confirm'))) return;
                }

                const formData = new FormData(form);
                let action = form.getAttribute('action');
                const method = (form.getAttribute('method') || 'POST').toUpperCase();

                const contentArea = document.getElementById('content-area');
                const loading = document.getElementById('loading');
                loading.style.display = 'block';
                contentArea.style.opacity = '0.5';

                let fetchOptions = { method: method };
                let requestUrl = action;

                if (method === 'GET') {
                    const params = new URLSearchParams(formData).toString();
                    requestUrl = action + "?" + params;
                } else {
                    fetchOptions.body = formData;
                }

                fetch(requestUrl, fetchOptions)
                    .then(response => {
                        if (!response.ok) throw new Error("网络请求失败");
                        return response.text();
                    })
                    .then(html => {
                        contentArea.innerHTML = html;
                        executeScripts(contentArea); // 再次执行脚本
                        loading.style.display = 'none';
                        contentArea.style.opacity = '1';

                        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.removeProperty('padding-right');
                        document.body.style.removeProperty('overflow');

                        bindFormEvents();
                    })
                    .catch(err => {
                        alert("提交失败: " + err.message);
                        loading.style.display = 'none';
                        contentArea.style.opacity = '1';
                    });
            };
        });
    }
</script>

</body>
</html>