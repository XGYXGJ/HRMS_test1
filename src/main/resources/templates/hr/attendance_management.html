<div class="container-fluid p-4">
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary"><i class="bi bi-calendar-check-fill me-2"></i>员工考勤管理</h5>
            <a onclick="loadContent('/hr/attendance/management', this)" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-repeat me-1"></i>刷新
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                    <tr>
                        <th>姓名</th>
                        <th>职位</th>
                        <th>所属机构</th>
                        <th class="text-center">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="employee : ${employees}">
                        <td th:text="${employee.name}"></td>
                        <td th:text="${employee.positionName}"></td>
                        <td th:text="${employee.orgName}"></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-info" th:onclick="|openCalendar(${employee.userId}, 'view')|">
                                <i class="bi bi-calendar-event"></i> 查看考勤
                            </button>
                            <button class="btn btn-sm btn-warning" th:onclick="|openCalendar(${employee.userId}, 'proxy')|">
                                <i class="bi bi-hand-index-thumb"></i> 代打卡
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Modal -->
<div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarModalLabel">员工考勤日历</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<script>
    'use strict';
    (function() {
        let calendar;
        let currentUserId;
        let currentMode; // 'view' or 'proxy'
        let calendarModal;

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;

            if (calendarModal) {
                calendarModal.dispose();
            }
            calendarModal = new bootstrap.Modal(document.getElementById('calendarModal'));

            if (calendar) {
                calendar.destroy();
            }
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-cn',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                events: [],
                dateClick: function(info) {
                    if (currentMode === 'proxy') {
                        window.handleProxyPunch(info.dateStr);
                    }
                }
            });
            calendar.render();

            document.getElementById('calendarModal').addEventListener('shown.bs.modal', function () {
                calendar.updateSize();
            });
        }

        window.openCalendar = function(userId, mode) {
            currentUserId = userId;
            currentMode = mode;

            const modalTitle = document.getElementById('calendarModalLabel');
            modalTitle.textContent = mode === 'view' ? '查看考勤记录' : '代打卡操作 (点击日期进行打卡/取消)';

            fetch(`/api/hr/attendance/${userId}`, {credentials: 'include'})
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(records => {
                    if (!Array.isArray(records)) {
                        console.error("Expected array but got:", records);
                        alert("获取考勤数据失败：服务器返回格式错误");
                        return;
                    }

                    const events = records.map(record => ({
                        title: '已打卡',
                        start: record.attendanceDate,
                        display: 'block',
                        classNames: ['attendance-event', 'attendance-present']
                    }));
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                    calendarModal.show();
                })
                .catch(error => {
                    console.error('Error fetching attendance data:', error);
                    alert('获取考勤数据失败，请查看控制台日志');
                });
        }

        window.handleProxyPunch = function(dateStr) {
            if (!confirm(`确定要为该员工在 ${dateStr} 进行打卡/取消打卡操作吗？`)) {
                return;
            }

            fetch('/api/hr/attendance/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: currentUserId,
                    date: dateStr
                }),
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('操作成功！');
                    window.openCalendar(currentUserId, currentMode);
                } else {
                    alert('操作失败: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error during proxy punch:', error);
                alert('操作发生错误');
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCalendar);
        } else {
            initializeCalendar();
        }
    })();
</script>
<style>
    .attendance-event {
        border: none !important;
        text-align: center;
        color: white !important;
    }
    .attendance-present {
        background-color: #28a745 !important;
    }
    .fc-day-today {
        background-color: #fff3cd !important;
    }
</style>