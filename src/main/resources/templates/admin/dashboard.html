<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>管理员工作台</title>
    <!-- 使用 BootCDN 替换本地资源 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/dashboard-common.css">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/fullcalendar/5.11.3/main.min.css" rel="stylesheet">

    <style>
        /* 管理员特有样式 */
        .dashboard-card .card-title {
            color: var(--primary-color);
        }
    </style>

    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src="https://cdn.bootcdn.net/ajax/libs/fullcalendar/5.11.3/main.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/fullcalendar/5.11.3/locales/zh-cn.min.js"></script>
</head>
<body>
<nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand" href="javascript:void(0)" onclick="loadContent('/admin/dashboard/home', this)">
        <i class="bi bi-shield-lock-fill me-2"></i>HRMS系统 - 管理员
    </a>
    <span class="text-white">欢迎，<span th:text="${session.user.username}">User</span></span>
    <a href="/logout" class="btn btn-sm btn-outline-light ms-3">
        <i class="bi bi-box-arrow-right me-1"></i>退出
    </a>
</nav>

<div class="sidebar">
    <div class="list-group list-group-flush" id="sidebarMenu">
        <a class="list-group-item list-group-item-action active" onclick="loadContent('/admin/dashboard/home', this)">
            <i class="bi bi-speedometer2"></i> 仪表盘
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/admin/org/list', this)">
            <i class="bi bi-building"></i> 机构管理
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/admin/position/list', this)">
            <i class="bi bi-diagram-3-fill"></i> 职位管理
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/admin/personnel/list', this)">
            <i class="bi bi-people-fill"></i> 人事档案管理
        </a>
        <!--
        <a class="list-group-item list-group-item-action" onclick="loadContent('/admin/audit/standards', this)">
            <i class="bi bi-check-circle-fill"></i> 薪酬标准审核
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/admin/audit/registers', this)">
            <i class="bi bi-cash-stack"></i> 薪酬发放审核
        </a>
        -->
        <a class="list-group-item list-group-item-action" onclick="loadContent('/admin/salary-item/list', this)">
            <i class="bi bi-gear-fill"></i> 薪酬项目管理
        </a>
        <a class="list-group-item list-group-item-action" onclick="loadContent('/admin/deleted-list', this)">
            <i class="bi bi-trash-fill"></i> 档案回收站
        </a>
    </div>
</div>

<div class="main-content">
    <div id="loading" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-3 text-muted">正在处理，请稍候...</p>
    </div>

    <div id="content-area">
        <!-- 内容将在这里动态加载 -->
    </div>
</div>

<script>
    // Handle browser back/forward buttons
    window.onpopstate = function(event) {
        if (event.state && event.state.url) {
            loadContent(event.state.url, null, false); // false to prevent pushing a new state
        }
    };

    // 初始化：默认加载仪表盘首页
    document.addEventListener('DOMContentLoaded', function() {
        const initialUrl = '/admin/dashboard/home';
        history.replaceState({url: initialUrl}, '', '#' + initialUrl);
        loadContent(initialUrl, document.querySelector('#sidebarMenu a.active'), false);
    });

    function executeScripts(container) {
        const scripts = container.querySelectorAll("script");
        scripts.forEach(script => {
            const newScript = document.createElement("script");
            // copy attributes
            for (let i = 0; i < script.attributes.length; i++) {
                const attr = script.attributes[i];
                newScript.setAttribute(attr.name, attr.value);
            }
            newScript.text = script.textContent; // use textContent
            script.parentNode.replaceChild(newScript, script);
        });
    }

    function loadContent(url, element, pushState = true) {
        // Update sidebar active state
        if (element && element.classList.contains('list-group-item')) {
            document.querySelectorAll('#sidebarMenu .list-group-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
        }

        // Push state to browser history
        if (pushState) {
            history.pushState({url: url}, '', '#' + url);
        }

        const contentArea = document.getElementById('content-area');
        const loading = document.getElementById('loading');

        contentArea.style.opacity = '0.5';
        loading.style.display = 'block';

        fetch(url, {credentials: 'include'})
            .then(response => {
                if (!response.ok) throw new Error("网络响应异常");
                const location = response.headers.get('X-Location');
                if (location) {
                    // Handle server-side redirect
                    loadContent(location, null, pushState);
                    return null;
                }
                return response.text();
            })
            .then(html => {
                if (html === null) return;
                contentArea.innerHTML = html;
                
                executeScripts(contentArea);
                bindFormEvents(); // Re-bind forms in the new content
                
                contentArea.style.opacity = '1';
                loading.style.display = 'none';
            })
            .catch(err => {
                contentArea.innerHTML = `<div class="alert alert-danger">加载失败: ${err.message}</div>`;
                loading.style.display = 'none';
                contentArea.style.opacity = '1';
            });
    }

    function bindFormEvents() {
        const forms = document.querySelectorAll('#content-area form');

        forms.forEach(form => {
            form.onsubmit = function(event) {
                event.preventDefault();

                const parentModal = form.closest('.modal.show');
                if (parentModal) {
                    let modalInstance = bootstrap.Modal.getInstance(parentModal);
                    if (!modalInstance) {
                        modalInstance = new bootstrap.Modal(parentModal);
                    }
                    modalInstance.hide();
                }

                if (form.getAttribute('onsubmit_confirm')) {
                    if (!confirm(form.getAttribute('onsubmit_confirm'))) return;
                }

                const formData = new FormData(form);
                let action = form.getAttribute('action');
                const method = (form.getAttribute('method') || 'POST').toUpperCase();

                const contentArea = document.getElementById('content-area');
                const loading = document.getElementById('loading');
                loading.style.display = 'block';
                contentArea.style.opacity = '0.5';

                let fetchOptions = { method: method, credentials: 'include' };
                let requestUrl = action;

                if (method === 'GET') {
                    const params = new URLSearchParams(formData).toString();
                    requestUrl = action + "?" + params;
                } else {
                    fetchOptions.body = formData;
                }

                fetch(requestUrl, fetchOptions)
                    .then(response => {
                        if (!response.ok) throw new Error("网络请求失败");

                        // Check for custom header to update URL
                        const newUrl = response.headers.get('X-Location');
                        if (newUrl) {
                            history.pushState({url: newUrl}, '', '#' + newUrl);
                        }

                        return response.text();
                    })
                    .then(html => {
                        contentArea.innerHTML = html;
                        executeScripts(contentArea); // 再次执行脚本
                        loading.style.display = 'none';
                        contentArea.style.opacity = '1';

                        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.removeProperty('padding-right');
                        document.body.style.removeProperty('overflow');

                        bindFormEvents();
                    })
                    .catch(err => {
                        alert("提交失败: " + err.message);
                        loading.style.display = 'none';
                        contentArea.style.opacity = '1';
                    });
            };
        });
    }
</script>

</body>
</html>