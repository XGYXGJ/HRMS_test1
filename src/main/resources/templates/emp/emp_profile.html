<div class="animate-fade-in">
    <!-- 利用 img onerror 注入脚本，确保在 innerHTML 赋值后执行 -->
    <img src="x" style="display:none" onerror="
        // 定义提交处理函数
        window.submitChangePassword = function() {
            const form = document.getElementById('changePasswordForm');
            const errorDiv = document.getElementById('password-error');

            // 简单的客户端验证
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (!newPass || !confirmPass) {
                errorDiv.textContent = '请输入密码';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPass !== confirmPass) {
                errorDiv.textContent = '新密码和确认密码不匹配。';
                errorDiv.style.display = 'block';
                return;
            }

            // 构造 FormData
            const formData = new FormData(form);

            // 发送 AJAX 请求
            fetch('/emp/change-password', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 1. 关闭模态框
                    const modalEl = document.getElementById('changePasswordModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();

                    // 2. 显示成功消息（在页面顶部）
                    const msgDiv = document.getElementById('profile-action-message');
                    if (msgDiv) {
                        msgDiv.className = 'alert alert-success';
                        msgDiv.textContent = '密码修改成功！';
                        msgDiv.style.display = 'block';

                        // 3秒后自动隐藏消息
                        setTimeout(() => {
                            msgDiv.style.display = 'none';
                        }, 3000);
                    }

                    // 3. 清空表单，但不刷新页面
                    form.reset();
                    // 隐藏错误提示（如果有）
                    errorDiv.style.display = 'none';

                } else {
                    // 显示错误消息
                    errorDiv.textContent = data.message || '修改失败';
                    errorDiv.style.display = 'block';
                }
            })
            .catch(err => {
                errorDiv.textContent = '网络请求失败，请稍后再试';
                errorDiv.style.display = 'block';
                console.error(err);
            });
        };

        // 处理回车键提交
        setTimeout(() => {
            const inputs = document.querySelectorAll('#changePasswordForm input');
            inputs.forEach(input => {
                input.onkeydown = function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        window.submitChangePassword();
                    }
                };
            });
        }, 100);

        // 移除此 img 标签
        this.remove();
    ">

    <!-- 消息提示区域 -->
    <div id="profile-action-message" class="alert" style="display: none;" role="alert"></div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>我的档案</h4>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                    修改密码
                </button>
            </div>
        </div>
        <div class="card-body">
            <div th:if="${profile}">
                <p><strong>姓名:</strong> <span th:text="${profile.name}"></span></p>
                <p><strong>性别:</strong> <span th:text="${profile.gender}"></span></p>
                <p><strong>手机号:</strong> <span th:text="${profile.phoneNumber}"></span></p>
                <p><strong>身份证号:</strong> <span th:text="${profile.idNumber}"></span></p>
                <p><strong>地址:</strong> <span th:text="${profile.address}"></span></p>
                <p><strong>所属机构:</strong> <span th:text="${organizationName != null ? organizationName : '未分配'}"></span></p>
                <p>
                    <strong>职位:</strong>
                    <span th:text="${position != null ? position.positionName : '未分配'}"></span>
                </p>
            </div>
            <div th:if="${profile == null}" class="alert alert-warning">
                您的档案信息不完整，请联系人事部门。
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">修改密码</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 注意：这里保留 form 标签用于样式和 FormData，但按钮类型改为 button 以避免触发默认 submit -->
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">当前密码</label>
                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">新密码</label>
                        <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">确认新密码</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                    </div>
                    <div id="password-error" class="alert alert-danger" style="display: none;"></div>
                    <!-- 关键修改：type="button" 配合 onclick，绕过全局的 submit 拦截 -->
                    <button type="button" class="btn btn-primary" onclick="submitChangePassword()">确认修改</button>
                </form>
            </div>
        </div>
    </div>
</div>