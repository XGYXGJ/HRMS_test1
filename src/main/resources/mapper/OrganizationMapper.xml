<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.hrms.mapper.OrganizationMapper">

    <select id="selectOrgList" resultType="com.example.hrms.dto.OrgDTO">
        SELECT
            o.Org_ID AS orgId,
            o.Org_Name AS orgName,
            o.L1_Org_Name AS l1OrgName,
            o.L2_Org_Name AS l2OrgName,
            o.L3_Org_Name AS l3OrgName,
            (SELECT GROUP_CONCAT(pf.Name SEPARATOR ', ')
             FROM T_User u
             JOIN T_Personnel_File pf ON u.User_ID = pf.User_ID
             WHERE u.L3_Org_ID = o.Org_ID AND u.Position_ID = 3) AS hrManagerName,
            (SELECT GROUP_CONCAT(pf.Name SEPARATOR ', ')
             FROM T_User u
             JOIN T_Personnel_File pf ON u.User_ID = pf.User_ID
             WHERE u.L3_Org_ID = o.Org_ID AND u.Position_ID = 4) AS salaryManagerName,
            (SELECT COUNT(*)
             FROM T_User u
             WHERE u.L3_Org_ID = o.Org_ID AND u.Position_ID NOT IN (3, 4)) AS employeeCount
        FROM
            T_Organization o
        WHERE o.level = 3
        ORDER BY o.L1_Org_Name, o.L2_Org_Name, o.L3_Org_Name
    </select>

</mapper>
