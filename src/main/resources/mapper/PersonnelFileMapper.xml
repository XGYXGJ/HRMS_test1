<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.hrms.mapper.PersonnelFileMapper">

    <select id="selectFilesWithOrgName" resultType="java.util.Map">
        SELECT
            pf.File_ID AS fileId,
            pf.Archive_No AS archiveNo,
            pf.User_ID AS userId,
            pf.Name AS name,
            pf.Phone_Number AS phoneNumber,
            pf.Audit_Status AS auditStatus,
            u.L3_Org_ID AS L3_Org_ID,  -- 使用 User 表的 Org ID
            o.Org_Name AS orgName,
            pos.Position_Name AS positionName
        FROM
            T_Personnel_File pf
                LEFT JOIN
            T_User u ON pf.User_ID = u.User_ID
                LEFT JOIN
            T_Organization o ON u.L3_Org_ID = o.Org_ID -- 关联 User 表的 Org ID
                LEFT JOIN
            T_Position pos ON u.Position_ID = pos.Position_ID
        <where>
            pf.Is_Deleted = 0
            <if test="l3OrgId != null">
                AND u.L3_Org_ID = #{l3OrgId} -- 使用 User 表的 Org ID 进行过滤
            </if>
            <if test="q != null and q != ''">
                AND (pf.Name LIKE CONCAT('%', #{q}, '%')
                OR pf.Archive_No LIKE CONCAT('%', #{q}, '%')
                OR o.Org_Name LIKE CONCAT('%', #{q}, '%')
                OR pos.Position_Name LIKE CONCAT('%', #{q}, '%'))
            </if>
        </where>
        ORDER BY
            pf.Creation_Time DESC
    </select>

</mapper>
