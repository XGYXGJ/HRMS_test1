<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.hrms.mapper.PersonnelFileMapper">

    <select id="selectFilesWithOrgName" resultType="com.example.hrms.dto.PersonnelFileDTO">
        SELECT
            pf.File_ID AS fileId,
            pf.Archive_No AS archiveNo,
            pf.User_ID AS userId,
            pf.Name AS name,
            pf.ID_Number AS idNumber,
            pf.Phone_Number AS phoneNumber,
            pf.Audit_Status AS auditStatus,
            u.L3_Org_ID AS l3OrgId,
            o.L1_Org_Name AS l1OrgName,
            o.L2_Org_Name AS l2OrgName,
            o.L3_Org_Name AS l3OrgName,
            pos.Position_Name AS positionName,
            pf.Creation_Time AS creationTime
        FROM
            T_Personnel_File pf
                LEFT JOIN
            T_User u ON pf.User_ID = u.User_ID
                LEFT JOIN
            T_Organization o ON u.L3_Org_ID = o.Org_ID
                LEFT JOIN
            T_Position pos ON u.Position_ID = pos.Position_ID
        <where>
            pf.Is_Deleted = 0
            <if test="l3OrgId != null">
                AND u.L3_Org_ID = #{l3OrgId}
            </if>
            <if test="q != null and q != ''">
                AND (pf.Name LIKE CONCAT('%', #{q}, '%')
                OR pf.Archive_No LIKE CONCAT('%', #{q}, '%')
                OR o.Org_Name LIKE CONCAT('%', #{q}, '%')
                OR pos.Position_Name LIKE CONCAT('%', #{q}, '%'))
            </if>
        </where>
        ORDER BY
            CASE
                WHEN pos.Position_Name = '人事经理' THEN 1
                WHEN pos.Position_Name = '薪酬经理' THEN 2
                ELSE 3
            END,
            CONVERT(pos.Position_Name USING gbk), -- 按拼音排序
            pf.Creation_Time DESC
    </select>

    <select id="selectDeletedFilesWithOrgName" resultType="com.example.hrms.dto.PersonnelFileDTO">
        SELECT
            pf.File_ID AS fileId,
            pf.Archive_No AS archiveNo,
            pf.Name AS name,
            o.L1_Org_Name AS l1OrgName,
            o.L2_Org_Name AS l2OrgName,
            o.L3_Org_Name AS l3OrgName,
            pos.Position_Name AS positionName,
            pf.Creation_Time AS creationTime
        FROM
            T_Personnel_File pf
                LEFT JOIN
            T_User u ON pf.User_ID = u.User_ID
                LEFT JOIN
            T_Organization o ON u.L3_Org_ID = o.Org_ID
                LEFT JOIN
            T_Position pos ON u.Position_ID = pos.Position_ID
        WHERE
            pf.Is_Deleted = 1
        ORDER BY
            pf.Creation_Time DESC
    </select>

    <select id="selectAuditHistory" resultType="com.example.hrms.dto.PersonnelFileDTO">
        SELECT
            pf.File_ID AS fileId,
            pf.Archive_No AS archiveNo,
            pf.User_ID AS userId,
            pf.Name AS name,
            pf.Audit_Status AS auditStatus,
            pf.L3_Org_ID AS l3OrgId,
            o_history.L1_Org_Name AS l1OrgName,
            o_history.L2_Org_Name AS l2OrgName,
            o_history.L3_Org_Name AS l3OrgName,
            o_current.L1_Org_Name AS currentL1OrgName,
            o_current.L2_Org_Name AS currentL2OrgName,
            o_current.L3_Org_Name AS currentL3OrgName,
            pos.Position_Name AS positionName,
            submitter.username as submitterName,
            pf.Creation_Time AS creationTime
        FROM
            T_Personnel_File pf
                LEFT JOIN
            T_User u ON pf.User_ID = u.User_ID
                LEFT JOIN
            T_Organization o_history ON pf.L3_Org_ID = o_history.Org_ID
                LEFT JOIN
            T_Organization o_current ON u.L3_Org_ID = o_current.Org_ID
                LEFT JOIN
            T_Position pos ON u.Position_ID = pos.Position_ID
                LEFT JOIN
            T_User submitter ON pf.HR_Submitter_ID = submitter.User_ID
        <where>
            pf.Audit_Status IN ('Approved', 'Rejected')
            <if test="q != null and q != ''">
                AND (pf.Name LIKE CONCAT('%', #{q}, '%')
                OR pf.Archive_No LIKE CONCAT('%', #{q}, '%')
                OR o_history.Org_Name LIKE CONCAT('%', #{q}, '%')
                OR o_current.Org_Name LIKE CONCAT('%', #{q}, '%')
                OR submitter.username LIKE CONCAT('%', #{q}, '%'))
            </if>
        </where>
        ORDER BY pf.Creation_Time DESC
    </select>

</mapper>
